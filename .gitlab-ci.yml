# GitLab CI/CD Pipeline for Admin Bot Service
# 
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ GitLab CI/CD Settings ‚Üí Variables:
# - DOCKER_HUB_USER       - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Docker Hub
# - DOCKER_HUB_TOKEN      - –¢–æ–∫–µ–Ω/–ø–∞—Ä–æ–ª—å Docker Hub (masked)
# - DEV_SERVER_HOST       - –•–æ—Å—Ç —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –¥–µ–ø–ª–æ—è
# - DEV_SERVER_USER       - SSH –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
# - SSH_PRIVATE_KEY       - SSH –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (masked, file)
# - POSTGRES_PASSWORD     - –ü–∞—Ä–æ–ª—å PostgreSQL (masked)
# - REDIS_PASSWORD        - –ü–∞—Ä–æ–ª—å Redis (masked)
# - TELEGRAM_BOT_TOKEN    - –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ (masked)
# - TELEGRAM_BOT_USERNAME - Username Telegram –±–æ—Ç–∞
# - ADMIN_WHITELIST       - Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

variables:
  # –ò–º—è Docker –æ–±—Ä–∞–∑–∞
  DOCKER_IMAGE: $DOCKER_HUB_USER/mc-admin
  # –¢–µ–≥ –æ–±—Ä–∞–∑–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - latest)
  DOCKER_TAG: latest
  # Java –≤–µ—Ä—Å–∏—è
  JAVA_VERSION: "21"
  # Maven –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end"

# –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .m2/repository/

# –°—Ç–∞–¥–∏–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞
stages:
#  - test
  - build
  - push
  - deploy

# ============================================================
# –°–¢–ê–î–ò–Ø: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ============================================================
#test:
#  stage: test
#  image: maven:3.9-eclipse-temurin-17
#  script:
#    - echo "üß™ Running unit tests..."
#    - ./mvnw $MAVEN_CLI_OPTS clean test
#  artifacts:
#    when: always
#    reports:
#      junit:
#        - target/surefire-reports/*.xml
#    paths:
#      - target/surefire-reports/
#    expire_in: 7 days
#  rules:
#    - if: $CI_COMMIT_BRANCH
#    - if: $CI_MERGE_REQUEST_IID

# ============================================================
# –°–¢–ê–î–ò–Ø: –°–ë–û–†–ö–ê DOCKER –û–ë–†–ê–ó–ê
# ============================================================
build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_DRIVER: overlay2
  before_script:
    - docker info
  script:
    - echo "üî® Building Docker image..."
    - docker build --no-cache --pull -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA $DOCKER_IMAGE:$DOCKER_TAG
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–∑ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç–∞–¥–∏–∏
    - docker save $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA > image.tar
  artifacts:
    paths:
      - image.tar
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_BRANCH == "master"  # –±—ã–ª–æ "main"
    - if: $CI_COMMIT_BRANCH == "develop"


# ============================================================
# –°–¢–ê–î–ò–Ø: PUSH –í DOCKER REGISTRY
# ============================================================
push:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker info
    # –õ–æ–≥–∏–Ω –≤ Docker Hub
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USER" --password-stdin
  script:
    - echo "üì¶ Pushing Docker image to registry..."
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –æ–±—Ä–∞–∑
    - docker load < image.tar
    # Push –æ–±—Ä–∞–∑ —Å –∫–æ—Ä–æ—Ç–∫–∏–º SHA
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
    # Push –æ–±—Ä–∞–∑ —Å —Ç–µ–≥–æ–º latest (—Ç–æ–ª—å–∫–æ –¥–ª—è main)
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        docker push $DOCKER_IMAGE:$DOCKER_TAG
        echo "‚úÖ Pushed $DOCKER_IMAGE:$DOCKER_TAG"
      fi
    # –î–ª—è develop –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–≥ develop
    - |
      if [ "$CI_COMMIT_BRANCH" == "develop" ]; then
        docker tag $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA $DOCKER_IMAGE:develop
        docker push $DOCKER_IMAGE:develop
        echo "‚úÖ Pushed $DOCKER_IMAGE:develop"
      fi
  after_script:
    - docker logout
  rules:
    - if: $CI_COMMIT_BRANCH == "master"  # –±—ã–ª–æ "main"
    - if: $CI_COMMIT_BRANCH == "develop"
  needs:
    - build

# ============================================================
# –°–¢–ê–î–ò–Ø: –î–ï–ü–õ–û–ô –ù–ê DEV –°–ï–†–í–ï–†
# ============================================================
deploy:dev:
  stage: deploy
  image: alpine:latest
  before_script:
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSH –∫–ª–∏–µ–Ω—Ç–∞
    - apk add --no-cache openssh-client
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEV_SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - echo "üöÄ Deploying to development server..."
    - export DOCKER_IMAGE_WITH_TAG="${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA}"
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST \
        "DOCKER_IMAGE='${DOCKER_IMAGE_WITH_TAG}' \
         POSTGRES_PASS='${POSTGRES_PASSWORD}' \
         TELEGRAM_TOKEN='${TELEGRAM_BOT_TOKEN}' \
         TELEGRAM_USERNAME='${TELEGRAM_BOT_USERNAME}' \
         ADMIN_LIST='${ADMIN_WHITELIST}' \
         bash -s" << 'EOF'
      set -e
      echo "üì• Pulling latest image: $DOCKER_IMAGE"
      docker pull "$DOCKER_IMAGE"

      echo "üõë Stopping old container..."
      docker stop mc-admin || true
      docker rm mc-admin || true

      echo "üöÄ Starting new container..."
      docker run -d \
        --name mc-friends \
        --network social-network-net \
        --restart unless-stopped \
        -p 8092:8092 \
        -e SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/friends_db \
        -e SPRING_DATASOURCE_USERNAME=postgres \
        -e SPRING_DATASOURCE_PASSWORD="$POSTGRES_PASS" \
        -e ACCOUNT_SERVICE_URL=http://mc-account:8080/internal/account \
        "$DOCKER_IMAGE"

      echo "üßπ Cleaning up old images..."
      docker image prune -f

      echo "‚úÖ Deployment complete!"
      docker ps | grep mc-friends
      EOF
  environment:
    name: development
    url: http://$DEV_SERVER_HOST:8092
  rules:
    - if: $CI_COMMIT_BRANCH == "master"  # –±—ã–ª–æ "main"
    - if: $CI_COMMIT_BRANCH == "develop"
  needs:
    - push

# ============================================================
# –°–¢–ê–î–ò–Ø: –î–ï–ü–õ–û–ô –ù–ê PRODUCTION (main –≤–µ—Ç–∫–∞)
# ============================================================
deploy:prod:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEV_SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - echo "üöÄ Deploying to development server..."
    - export DOCKER_IMAGE_WITH_TAG="${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA}"
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST \
        "DOCKER_IMAGE='${DOCKER_IMAGE_WITH_TAG}' \
         POSTGRES_PASS='${POSTGRES_PASSWORD}' \
         TELEGRAM_TOKEN='${TELEGRAM_BOT_TOKEN}' \
         TELEGRAM_USERNAME='${TELEGRAM_BOT_USERNAME}' \
         ADMIN_LIST='${ADMIN_WHITELIST}' \
         bash -s" << 'EOF'
      set -e
      echo "üì• Pulling latest image: $DOCKER_IMAGE"
      docker pull "$DOCKER_IMAGE"

      echo "üõë Stopping old container..."
      docker stop mc-admin || true
      docker rm mc-admin || true

      echo "üöÄ Starting new container..."
      docker run -d \
        --name mc-friends \
        --network social-network-net \
        --restart unless-stopped \
        -p 8092:8092 \
        -e SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/friends_db \
        -e SPRING_DATASOURCE_USERNAME=postgres \
        -e SPRING_DATASOURCE_PASSWORD="$POSTGRES_PASS" \
        -e ACCOUNT_SERVICE_URL=http://mc-account:8080/internal/account \
        "$DOCKER_IMAGE"

      echo "üßπ Cleaning up old images..."
      docker image prune -f

      echo "‚úÖ Deployment complete!"
      docker ps | grep mc-friends
      EOF
  environment:
    name: production
    url: http://$DEV_SERVER_HOST:8092
  rules:
    - if: $CI_COMMIT_BRANCH == "master"  # –±—ã–ª–æ "main"
    - if: $CI_COMMIT_BRANCH == "develop"
  needs:
    - push
